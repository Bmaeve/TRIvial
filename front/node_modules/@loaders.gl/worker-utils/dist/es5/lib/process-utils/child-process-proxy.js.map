{"version":3,"file":"child-process-proxy.js","names":["DEFAULT_PROPS","command","arguments","port","autoPort","wait","onSuccess","processProxy","console","log","props","ChildProcessProxy","id","args","Number","portArg","getAvailablePort","push","String","Promise","resolve","reject","_setTimeout","join","childProcess","ChildProcess","spawn","stdout","on","data","toString","stderr","_clearTimeout","Error","error","code","kill","statusCode","stop","process","exit","message","callback","successTimer","setTimeout","clearTimeout"],"sources":["../../../../src/lib/process-utils/child-process-proxy.ts"],"sourcesContent":["/* eslint-disable no-console */\n// Avoid using named imports for Node builtins to help with \"empty\" resolution\n// for bundlers targeting browser environments. Access imports & types\n// through the `ChildProcess` object (e.g. `ChildProcess.spawn`, `ChildProcess.ChildProcess`).\nimport * as ChildProcess from 'child_process';\nimport {getAvailablePort} from './process-utils';\n\nexport type ChildProcessProxyProps = {\n  command: string;\n  arguments: string[];\n  /** Whether to add a port specified arg */\n  portArg?: string;\n  /** Base port number */\n  port?: number;\n  /** Whether to search for an available port if the base port is occupied */\n  autoPort?: boolean;\n  /** Number of milliseconds to wait until concluding success */\n  /** wait: 0 - infinity */\n  wait?: number;\n  /** Options passed on to Node'.js `spawn` */\n  spawn?: ChildProcess.SpawnOptionsWithoutStdio;\n  /** Callback when the  */\n  onStart?: (proxy: ChildProcessProxy) => void;\n  onSuccess?: (proxy: ChildProcessProxy) => void;\n};\n\nconst DEFAULT_PROPS: ChildProcessProxyProps = {\n  command: '',\n  arguments: [],\n  port: 5000,\n  autoPort: true,\n  wait: 2000,\n  onSuccess: (processProxy) => {\n    console.log(`Started ${processProxy.props.command}`);\n  }\n};\n\n/**\n * Manager for a Node.js child process\n * Prepares arguments, starts, stops and tracks output\n */\nexport default class ChildProcessProxy {\n  id: string;\n  props: ChildProcessProxyProps = {...DEFAULT_PROPS};\n  private childProcess: ChildProcess.ChildProcess | null = null;\n  private port: number = 0;\n  private successTimer?: any; // NodeJS.Timeout;\n\n  // constructor(props?: {id?: string});\n  constructor({id = 'browser-driver'} = {}) {\n    this.id = id;\n  }\n\n  /** Starts a child process with the provided props */\n  async start(props: ChildProcessProxyProps): Promise<object> {\n    props = {...DEFAULT_PROPS, ...props};\n    this.props = props;\n\n    const args = [...props.arguments];\n\n    // If portArg is set, we can look up an available port\n    this.port = Number(props.port);\n    if (props.portArg) {\n      if (props.autoPort) {\n        this.port = await getAvailablePort(props.port);\n      }\n      args.push(props.portArg, String(this.port));\n    }\n\n    return await new Promise((resolve, reject) => {\n      try {\n        this._setTimeout(() => {\n          if (props.onSuccess) {\n            props.onSuccess(this);\n          }\n          resolve({});\n        });\n\n        console.log(`Spawning ${props.command} ${props.arguments.join(' ')}`);\n        const childProcess = ChildProcess.spawn(props.command, args, props.spawn);\n        this.childProcess = childProcess;\n\n        childProcess.stdout.on('data', (data) => {\n          console.log(data.toString());\n        });\n        // TODO - add option regarding whether stderr should be treated as data\n        childProcess.stderr.on('data', (data) => {\n          console.log(`Child process wrote to stderr: \"${data}\".`);\n          this._clearTimeout();\n          reject(new Error(data));\n        });\n        childProcess.on('error', (error) => {\n          console.log(`Child process errored with ${error}`);\n          this._clearTimeout();\n          reject(error);\n        });\n        childProcess.on('close', (code) => {\n          console.log(`Child process exited with ${code}`);\n          this.childProcess = null;\n          this._clearTimeout();\n          resolve({});\n        });\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /** Stops a running child process */\n  async stop(): Promise<void> {\n    if (this.childProcess) {\n      this.childProcess.kill();\n      this.childProcess = null;\n    }\n  }\n\n  /** Exits this process */\n  async exit(statusCode: number = 0): Promise<void> {\n    try {\n      await this.stop();\n      // eslint-disable-next-line no-process-exit\n      process.exit(statusCode);\n    } catch (error) {\n      console.error((error as Error).message || error);\n      // eslint-disable-next-line no-process-exit\n      process.exit(1);\n    }\n  }\n\n  _setTimeout(callback: (...args: any[]) => void) {\n    if (Number(this.props.wait) > 0) {\n      this.successTimer = setTimeout(callback, this.props.wait);\n    }\n  }\n\n  _clearTimeout() {\n    if (this.successTimer) {\n      clearTimeout(this.successTimer);\n    }\n  }\n}\n"],"mappings":"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"}