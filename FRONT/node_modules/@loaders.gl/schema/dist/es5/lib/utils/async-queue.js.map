{"version":3,"file":"async-queue.js","names":["ArrayQueue","value","push","shift","Array","Symbol","asyncIterator","AsyncQueue","_values","_settlers","_closed","length","dequeue","resolve","done","Error","settler","reject","enqueue","Promise","takeAsync","asyncIterable","count","Infinity","result","iterator","next"],"sources":["../../../../src/lib/utils/async-queue.ts"],"sourcesContent":["// From https://github.com/rauschma/async-iter-demo/tree/master/src under MIT license\n// http://2ality.com/2016/10/asynchronous-iteration.html\n\nclass ArrayQueue<T> extends Array<T> {\n  enqueue(value: T) {\n    // Add at the end\n    return this.push(value);\n  }\n  dequeue(): T {\n    // Remove first element\n    return this.shift() as T;\n  }\n}\n\nexport default class AsyncQueue<T> {\n  private _values: ArrayQueue<T | Error>;\n  private _settlers: ArrayQueue<{resolve: (value: any) => void; reject: (reason?: any) => void}>;\n  private _closed: boolean;\n\n  constructor() {\n    // enqueues > dequeues\n    this._values = new ArrayQueue<T>();\n    // dequeues > enqueues\n    this._settlers = new ArrayQueue<{\n      resolve: (value: any) => void;\n      reject: (reason?: any) => void;\n    }>();\n    this._closed = false;\n  }\n\n  close(): void {\n    while (this._settlers.length > 0) {\n      this._settlers.dequeue().resolve({done: true});\n    }\n    this._closed = true;\n  }\n\n  [Symbol.asyncIterator](): AsyncIterator<T> {\n    return this;\n  }\n\n  enqueue(value: T | Error): void {\n    if (this._closed) {\n      throw new Error('Closed');\n    }\n\n    if (this._settlers.length > 0) {\n      if (this._values.length > 0) {\n        throw new Error('Illegal internal state');\n      }\n      const settler = this._settlers.dequeue();\n      if (value instanceof Error) {\n        settler.reject(value);\n      } else {\n        settler.resolve({value});\n      }\n    } else {\n      this._values.enqueue(value);\n    }\n  }\n\n  /**\n   * @returns a Promise for an IteratorResult\n   */\n  next(): Promise<any> {\n    if (this._values.length > 0) {\n      const value = this._values.dequeue();\n      if (value instanceof Error) {\n        return Promise.reject(value);\n      }\n      return Promise.resolve({value});\n    }\n\n    if (this._closed) {\n      if (this._settlers.length > 0) {\n        throw new Error('Illegal internal state');\n      }\n      return Promise.resolve({done: true});\n    }\n    // Wait for new values to be enqueued\n    return new Promise((resolve, reject) => {\n      this._settlers.enqueue({resolve, reject});\n    });\n  }\n}\n\n/**\n * @returns a Promise for an Array with the elements in `asyncIterable`\n */\nexport async function takeAsync(\n  asyncIterable: AsyncIterable<any>,\n  count = Infinity\n): Promise<any[]> {\n  const result: Array<any> = [];\n  const iterator = asyncIterable[Symbol.asyncIterator]();\n  while (result.length < count) {\n    const {value, done} = await iterator.next();\n    if (done) {\n      break;\n    }\n    result.push(value);\n  }\n  return result;\n}\n"],"mappings":"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"}